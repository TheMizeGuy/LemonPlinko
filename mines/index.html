<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Lemon Mines</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      min-height: 100vh;
      background: linear-gradient(135deg, #0a0e1a 0%, #151c2c 50%, #0d1320 100%);
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      color: #fff;
      padding: 20px;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      gap: 24px;
    }

    .panel {
      background: linear-gradient(180deg, rgba(30, 41, 59, 0.8) 0%, rgba(15, 23, 42, 0.9) 100%);
      border-radius: 20px;
      padding: 24px;
      border: 1px solid rgba(255, 255, 255, 0.08);
      backdrop-filter: blur(20px);
    }

    .left-panel {
      width: 320px;
    }

    .right-panel {
      width: 280px;
      max-height: 750px;
      overflow: hidden;
    }

    .balance-display {
      background: linear-gradient(135deg, rgba(250, 204, 21, 0.15) 0%, rgba(234, 179, 8, 0.1) 100%);
      border-radius: 14px;
      padding: 20px;
      margin-bottom: 24px;
      border: 1px solid rgba(250, 204, 21, 0.2);
    }

    .balance-label {
      font-size: 12px;
      color: #9ca3af;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 6px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .balance-value {
      font-size: 32px;
      font-weight: 700;
      color: #facc15;
      font-family: 'JetBrains Mono', monospace;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .section-label {
      font-size: 13px;
      color: #9ca3af;
      text-transform: uppercase;
      letter-spacing: 1px;
      display: block;
      margin-bottom: 10px;
    }

    .bet-input {
      width: 100%;
      background: rgba(15, 23, 42, 0.8);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 10px;
      padding: 14px;
      color: #fff;
      font-size: 18px;
      font-family: 'JetBrains Mono', monospace;
      outline: none;
    }

    .bet-input:focus {
      border-color: rgba(250, 204, 21, 0.5);
    }

    .bet-input:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .btn-group {
      display: flex;
      gap: 8px;
      margin-top: 10px;
    }

    .btn-small {
      flex: 1;
      padding: 10px;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      color: #9ca3af;
      font-size: 13px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-small:hover:not(:disabled) {
      background: rgba(255, 255, 255, 0.1);
    }

    .btn-small:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .mines-selector {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 8px;
      margin-top: 10px;
    }

    .mines-btn {
      padding: 12px 8px;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      color: #9ca3af;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .mines-btn:hover:not(:disabled) {
      background: rgba(255, 255, 255, 0.1);
    }

    .mines-btn.active {
      background: rgba(239, 68, 68, 0.3);
      border-color: #ef4444;
      color: #ef4444;
    }

    .mines-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .btn-play {
      width: 100%;
      padding: 18px;
      background: linear-gradient(135deg, #facc15 0%, #eab308 100%);
      border: none;
      border-radius: 14px;
      color: #000;
      font-size: 18px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.2s;
      box-shadow: 0 4px 20px rgba(250, 204, 21, 0.4);
      margin-bottom: 12px;
    }

    .btn-play:hover:not(:disabled) {
      transform: translateY(-1px);
      box-shadow: 0 6px 25px rgba(250, 204, 21, 0.5);
    }

    .btn-play:disabled {
      background: rgba(255, 255, 255, 0.1);
      color: #6b7280;
      box-shadow: none;
      cursor: not-allowed;
      transform: none;
    }

    .btn-cashout {
      width: 100%;
      padding: 18px;
      background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
      border: none;
      border-radius: 14px;
      color: #fff;
      font-size: 18px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.2s;
      box-shadow: 0 4px 20px rgba(34, 197, 94, 0.4);
      margin-bottom: 12px;
    }

    .btn-cashout:hover:not(:disabled) {
      transform: translateY(-1px);
      box-shadow: 0 6px 25px rgba(34, 197, 94, 0.5);
    }

    .btn-cashout:disabled {
      background: rgba(255, 255, 255, 0.1);
      color: #6b7280;
      box-shadow: none;
      cursor: not-allowed;
      transform: none;
    }

    .current-game-info {
      background: rgba(0, 0, 0, 0.2);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 16px;
    }

    .game-info-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    }

    .game-info-row:last-child {
      border-bottom: none;
    }

    .game-info-label {
      font-size: 13px;
      color: #9ca3af;
    }

    .game-info-value {
      font-size: 15px;
      font-weight: 600;
      font-family: 'JetBrains Mono', monospace;
      color: #fff;
    }

    .game-info-value.profit {
      color: #22c55e;
    }

    .game-info-value.multiplier {
      color: #facc15;
    }

    .result-box {
      margin-top: 16px;
      padding: 14px;
      border-radius: 12px;
    }

    .result-box.win {
      background: rgba(34, 197, 94, 0.15);
      border: 1px solid rgba(34, 197, 94, 0.3);
    }

    .result-box.loss {
      background: rgba(239, 68, 68, 0.15);
      border: 1px solid rgba(239, 68, 68, 0.3);
    }

    .result-label {
      font-size: 12px;
      color: #9ca3af;
      margin-bottom: 6px;
    }

    .result-value {
      font-size: 22px;
      font-weight: 700;
      font-family: 'JetBrains Mono', monospace;
    }

    .result-value.win {
      color: #22c55e;
    }

    .result-value.loss {
      color: #ef4444;
    }

    .profit-box {
      margin-top: 14px;
      padding: 14px;
      background: rgba(255, 255, 255, 0.03);
      border-radius: 12px;
      border: 1px solid rgba(255, 255, 255, 0.06);
    }

    .game-board {
      background: linear-gradient(180deg, rgba(30, 41, 59, 0.6) 0%, rgba(15, 23, 42, 0.8) 100%);
      border-radius: 24px;
      padding: 24px;
      border: 1px solid rgba(255, 255, 255, 0.08);
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
    }

    .game-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .game-title {
      font-size: 28px;
      font-weight: 800;
      background: linear-gradient(135deg, #facc15 0%, #eab308 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      letter-spacing: -0.5px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .made-by {
      font-size: 14px;
      font-weight: 400;
      color: #9ca3af;
      margin-left: 8px;
      font-style: italic;
      -webkit-text-fill-color: #9ca3af;
    }

    .game-badges {
      display: flex;
      gap: 12px;
      align-items: center;
    }

    .badge {
      font-size: 13px;
      padding: 8px 14px;
      border-radius: 20px;
      font-weight: 600;
      text-transform: uppercase;
    }

    .badge-mines {
      background: rgba(239, 68, 68, 0.2);
      color: #ef4444;
    }

    .badge-gems {
      background: rgba(34, 197, 94, 0.2);
      color: #22c55e;
    }

    .mines-grid {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 10px;
      padding: 20px;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 16px;
      margin-bottom: 20px;
    }

    .mine-cell {
      aspect-ratio: 1;
      background: linear-gradient(180deg, rgba(51, 65, 85, 0.8) 0%, rgba(30, 41, 59, 0.9) 100%);
      border: 2px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 32px;
      cursor: pointer;
      transition: all 0.15s ease;
      position: relative;
      overflow: hidden;
    }

    .mine-cell:hover:not(.revealed):not(.disabled) {
      background: linear-gradient(180deg, rgba(71, 85, 105, 0.8) 0%, rgba(51, 65, 85, 0.9) 100%);
      border-color: rgba(255, 255, 255, 0.2);
      transform: scale(1.05);
    }

    .mine-cell.disabled {
      cursor: not-allowed;
      opacity: 0.7;
    }

    .mine-cell.revealed {
      cursor: default;
      transform: scale(1);
    }

    .mine-cell.gem {
      background: linear-gradient(135deg, rgba(34, 197, 94, 0.4) 0%, rgba(22, 163, 74, 0.3) 100%);
      border-color: #22c55e;
      box-shadow: 0 0 20px rgba(34, 197, 94, 0.4);
      animation: gemReveal 0.4s ease-out;
    }

    .mine-cell.mine {
      background: linear-gradient(135deg, rgba(239, 68, 68, 0.5) 0%, rgba(220, 38, 38, 0.4) 100%);
      border-color: #ef4444;
      box-shadow: 0 0 20px rgba(239, 68, 68, 0.5);
      animation: mineReveal 0.4s ease-out;
    }

    .mine-cell.mine-revealed {
      background: linear-gradient(135deg, rgba(239, 68, 68, 0.2) 0%, rgba(220, 38, 38, 0.15) 100%);
      border-color: rgba(239, 68, 68, 0.5);
      opacity: 0.6;
    }

    .mine-cell.gem-unrevealed {
      background: linear-gradient(135deg, rgba(34, 197, 94, 0.2) 0%, rgba(22, 163, 74, 0.15) 100%);
      border-color: rgba(34, 197, 94, 0.5);
      opacity: 0.6;
    }

    @keyframes gemReveal {
      0% {
        transform: scale(0.8) rotateY(90deg);
        opacity: 0;
      }
      50% {
        transform: scale(1.1) rotateY(0deg);
      }
      100% {
        transform: scale(1) rotateY(0deg);
        opacity: 1;
      }
    }

    @keyframes mineReveal {
      0% {
        transform: scale(0.5);
        opacity: 0;
      }
      50% {
        transform: scale(1.3);
      }
      100% {
        transform: scale(1);
        opacity: 1;
      }
    }

    .cell-content {
      font-size: 36px;
      line-height: 1;
    }

    .multiplier-display {
      background: linear-gradient(135deg, rgba(250, 204, 21, 0.15) 0%, rgba(234, 179, 8, 0.1) 100%);
      border: 1px solid rgba(250, 204, 21, 0.3);
      border-radius: 12px;
      padding: 16px 24px;
      text-align: center;
      margin-bottom: 16px;
    }

    .multiplier-label {
      font-size: 12px;
      color: #9ca3af;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 4px;
    }

    .multiplier-value {
      font-size: 36px;
      font-weight: 800;
      color: #facc15;
      font-family: 'JetBrains Mono', monospace;
    }

    .next-multiplier {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: rgba(0, 0, 0, 0.2);
      border-radius: 10px;
      padding: 12px 16px;
    }

    .next-label {
      font-size: 12px;
      color: #6b7280;
    }

    .next-value {
      font-size: 16px;
      font-weight: 700;
      color: #22c55e;
      font-family: 'JetBrains Mono', monospace;
    }

    .stats-bar {
      display: flex;
      justify-content: space-around;
      background: rgba(0, 0, 0, 0.2);
      border-radius: 12px;
      padding: 16px 20px;
      margin-top: 16px;
    }

    .stat-item {
      text-align: center;
    }

    .stat-label {
      font-size: 11px;
      color: #6b7280;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 4px;
    }

    .stat-value {
      font-size: 20px;
      font-weight: 700;
      font-family: 'JetBrains Mono', monospace;
      color: #fff;
    }

    .history-title {
      font-size: 16px;
      font-weight: 600;
      color: #fff;
      margin-bottom: 18px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .history-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
      max-height: 600px;
      overflow-y: auto;
    }

    .history-empty {
      color: #6b7280;
      font-size: 14px;
      text-align: center;
      padding: 50px 0;
    }

    .history-item {
      padding: 12px 14px;
      background: rgba(255, 255, 255, 0.03);
      border-radius: 10px;
      border: 1px solid rgba(255, 255, 255, 0.05);
    }

    .history-item-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
    }

    .history-result {
      padding: 4px 10px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 700;
    }

    .history-result.win {
      background: rgba(34, 197, 94, 0.2);
      color: #22c55e;
    }

    .history-result.loss {
      background: rgba(239, 68, 68, 0.2);
      color: #ef4444;
    }

    .history-profit {
      font-size: 14px;
      font-weight: 600;
      font-family: 'JetBrains Mono', monospace;
    }

    .history-profit.win {
      color: #22c55e;
    }

    .history-profit.loss {
      color: #ef4444;
    }

    .history-details {
      font-size: 12px;
      color: #9ca3af;
      font-family: 'JetBrains Mono', monospace;
    }

    .section {
      margin-bottom: 20px;
    }

    ::-webkit-scrollbar {
      width: 6px;
    }

    ::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 3px;
    }

    ::-webkit-scrollbar-thumb {
      background: rgba(255, 255, 255, 0.2);
      border-radius: 3px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: rgba(255, 255, 255, 0.3);
    }

    .lemon-icon {
      font-size: 20px;
    }

    .payout-table {
      margin-top: 16px;
      background: rgba(0, 0, 0, 0.2);
      border-radius: 12px;
      padding: 12px;
      max-height: 200px;
      overflow-y: auto;
    }

    .payout-table-title {
      font-size: 11px;
      color: #6b7280;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 8px;
      text-align: center;
    }

    .payout-row {
      display: flex;
      justify-content: space-between;
      padding: 6px 8px;
      font-size: 12px;
      font-family: 'JetBrains Mono', monospace;
      border-radius: 4px;
    }

    .payout-row:nth-child(even) {
      background: rgba(255, 255, 255, 0.02);
    }

    .payout-row.current {
      background: rgba(250, 204, 21, 0.2);
      border: 1px solid rgba(250, 204, 21, 0.3);
    }

    .payout-gems {
      color: #22c55e;
    }

    .payout-mult {
      color: #facc15;
    }

    @media (max-width: 1100px) {
      body {
        flex-direction: column;
        align-items: center;
      }
      
      .left-panel, .right-panel {
        width: 100%;
        max-width: 500px;
      }

      .game-board {
        width: 100%;
        max-width: 500px;
      }
    }
  </style>
</head>
<body>
  <!-- Left Panel - Controls -->
  <div class="panel left-panel">
    <!-- Balance Display -->
    <div class="balance-display">
      <div class="balance-label">
        <span class="lemon-icon">üçã</span> Balance
      </div>
      <div class="balance-value">
        <span id="balanceValue">1000.00</span>
        <span style="font-size: 16px; font-weight: 500;">Lemons</span>
      </div>
    </div>

    <!-- Bet Amount -->
    <div class="section">
      <label class="section-label">Bet Amount (Lemons)</label>
      <input type="number" id="betInput" class="bet-input" value="10" min="1">
      <div class="btn-group">
        <button class="btn-small" id="betHalf" onclick="adjustBet(0.5)">¬Ωx</button>
        <button class="btn-small" id="betDouble" onclick="adjustBet(2)">2x</button>
        <button class="btn-small" id="betMax" onclick="setBetMax()">MAX</button>
      </div>
    </div>

    <!-- Mines Selection -->
    <div class="section">
      <label class="section-label">Number of Mines</label>
      <div class="mines-selector" id="minesSelector">
        <button class="mines-btn" data-mines="1">1</button>
        <button class="mines-btn" data-mines="3">3</button>
        <button class="mines-btn active" data-mines="5">5</button>
        <button class="mines-btn" data-mines="7">7</button>
        <button class="mines-btn" data-mines="10">10</button>
        <button class="mines-btn" data-mines="12">12</button>
        <button class="mines-btn" data-mines="15">15</button>
        <button class="mines-btn" data-mines="24">24</button>
      </div>
    </div>

    <!-- Play/Cashout Button -->
    <button class="btn-play" id="playBtn" onclick="startGame()">
      üéÆ Start Game
    </button>
    <button class="btn-cashout" id="cashoutBtn" onclick="cashout()" disabled style="display: none;">
      üí∞ Cashout
    </button>

    <!-- Current Game Info -->
    <div class="current-game-info" id="gameInfo" style="display: none;">
      <div class="game-info-row">
        <span class="game-info-label">Gems Found</span>
        <span class="game-info-value" id="gemsFound">0 / 20</span>
      </div>
      <div class="game-info-row">
        <span class="game-info-label">Current Multiplier</span>
        <span class="game-info-value multiplier" id="currentMult">1.00x</span>
      </div>
      <div class="game-info-row">
        <span class="game-info-label">Potential Win</span>
        <span class="game-info-value profit" id="potentialWin">0.00 üçã</span>
      </div>
    </div>

    <!-- Payout Table -->
    <div class="payout-table" id="payoutTable">
      <div class="payout-table-title">Multiplier Table</div>
      <div id="payoutRows"></div>
    </div>

    <!-- Last Result -->
    <div class="result-box win" id="lastResult" style="display: none;">
      <div class="result-label">Last Result</div>
      <div class="result-value win" id="lastResultValue"></div>
    </div>

    <!-- Total Profit -->
    <div class="profit-box">
      <div class="result-label">Session Profit</div>
      <div class="result-value win" id="profitValue" style="font-size: 18px;">+0.00 üçã</div>
    </div>
  </div>

  <!-- Center - Game Board -->
  <div class="game-board">
    <div class="game-header">
      <div class="game-title">
        <span>üçã</span> LEMON MINES <span class="made-by">- made by mize</span>
      </div>
      <div class="game-badges">
        <span class="badge badge-mines" id="minesBadge">5 Mines</span>
        <span class="badge badge-gems" id="gemsBadge">20 Gems</span>
      </div>
    </div>

    <!-- Multiplier Display -->
    <div class="multiplier-display">
      <div class="multiplier-label">Current Multiplier</div>
      <div class="multiplier-value" id="multiplierDisplay">1.00x</div>
    </div>

    <!-- Mines Grid -->
    <div class="mines-grid" id="minesGrid">
      <!-- 25 cells will be generated here -->
    </div>

    <!-- Next Multiplier -->
    <div class="next-multiplier">
      <span class="next-label">Next gem multiplier:</span>
      <span class="next-value" id="nextMultiplier">1.04x</span>
    </div>

    <div class="stats-bar">
      <div class="stat-item">
        <div class="stat-label">Games Played</div>
        <div class="stat-value" id="statGames">0</div>
      </div>
      <div class="stat-item">
        <div class="stat-label">Wins</div>
        <div class="stat-value" id="statWins" style="color: #22c55e;">0</div>
      </div>
      <div class="stat-item">
        <div class="stat-label">Losses</div>
        <div class="stat-value" id="statLosses" style="color: #ef4444;">0</div>
      </div>
      <div class="stat-item">
        <div class="stat-label">Best Multi</div>
        <div class="stat-value" id="statBestMult" style="color: #facc15;">0x</div>
      </div>
    </div>
  </div>

  <!-- Right Panel - History -->
  <div class="panel right-panel">
    <div class="history-title">
      <span>üìä</span> History
    </div>
    <div class="history-list" id="historyList">
      <div class="history-empty">No games played yet</div>
    </div>
  </div>

  <script>
    // Game constants
    const TOTAL_CELLS = 25;
    const HOUSE_EDGE = 0.01; // 1% house edge

    // Game state
    let balance = 1000;
    let betAmount = 10;
    let minesCount = 5;
    let gameInProgress = false;
    let minePositions = [];
    let revealedCells = [];
    let currentMultiplier = 1;
    let gemsFound = 0;
    let totalProfit = 0;
    let stats = { games: 0, wins: 0, losses: 0, bestMult: 0 };
    let history = [];
    let gameIdCounter = 0;

    // Calculate multiplier for a given number of gems revealed
    function calculateMultiplier(gems, mines) {
      if (gems === 0) return 1;
      
      const totalCells = TOTAL_CELLS;
      const safeCells = totalCells - mines;
      
      // Calculate fair odds multiplier
      let multiplier = 1;
      for (let i = 0; i < gems; i++) {
        const remaining = totalCells - i;
        const safeRemaining = safeCells - i;
        multiplier *= remaining / safeRemaining;
      }
      
      // Apply house edge
      multiplier *= (1 - HOUSE_EDGE);
      
      return Math.max(1, multiplier);
    }

    // Generate multiplier table for current mines setting
    function generatePayoutTable() {
      const container = document.getElementById('payoutRows');
      const safeCells = TOTAL_CELLS - minesCount;
      let html = '';
      
      for (let gems = 1; gems <= safeCells; gems++) {
        const mult = calculateMultiplier(gems, minesCount);
        const isCurrent = gems === gemsFound + 1;
        html += `
          <div class="payout-row ${isCurrent ? 'current' : ''}" data-gems="${gems}">
            <span class="payout-gems">${gems} üíé</span>
            <span class="payout-mult">${mult.toFixed(2)}x</span>
          </div>
        `;
      }
      
      container.innerHTML = html;
      
      // Scroll to current row if game in progress
      if (gameInProgress && gemsFound > 0) {
        const currentRow = container.querySelector('.payout-row.current');
        if (currentRow) {
          currentRow.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
      }
    }

    // Initialize the grid
    function initGrid() {
      const grid = document.getElementById('minesGrid');
      grid.innerHTML = '';
      
      for (let i = 0; i < TOTAL_CELLS; i++) {
        const cell = document.createElement('div');
        cell.className = 'mine-cell disabled';
        cell.dataset.index = i;
        cell.onclick = () => revealCell(i);
        grid.appendChild(cell);
      }
    }

    // Reset grid for new game
    function resetGrid() {
      const cells = document.querySelectorAll('.mine-cell');
      cells.forEach(cell => {
        cell.className = 'mine-cell';
        cell.innerHTML = '';
      });
    }

    // Start new game
    function startGame() {
      if (balance < betAmount) return;

      // Deduct bet
      balance -= betAmount;
      updateBalance();

      // Reset state
      gameInProgress = true;
      revealedCells = [];
      gemsFound = 0;
      currentMultiplier = 1;

      // Generate random mine positions
      minePositions = [];
      const positions = Array.from({ length: TOTAL_CELLS }, (_, i) => i);
      for (let i = 0; i < minesCount; i++) {
        const randomIndex = Math.floor(Math.random() * positions.length);
        minePositions.push(positions.splice(randomIndex, 1)[0]);
      }

      // Reset and enable grid
      resetGrid();
      const cells = document.querySelectorAll('.mine-cell');
      cells.forEach(cell => cell.classList.remove('disabled'));

      // Update UI
      updateGameInfo();
      updateButtons();
      generatePayoutTable();
      
      document.getElementById('gameInfo').style.display = 'block';
      document.getElementById('multiplierDisplay').textContent = '1.00x';
      document.getElementById('nextMultiplier').textContent = calculateMultiplier(1, minesCount).toFixed(2) + 'x';
    }

    // Reveal a cell
    function revealCell(index) {
      if (!gameInProgress) return;
      if (revealedCells.includes(index)) return;

      const cell = document.querySelector(`.mine-cell[data-index="${index}"]`);
      revealedCells.push(index);

      if (minePositions.includes(index)) {
        // Hit a mine - game over
        cell.classList.add('mine', 'revealed');
        cell.innerHTML = '<span class="cell-content">üí£</span>';
        gameOver(false);
      } else {
        // Found a gem
        cell.classList.add('gem', 'revealed');
        cell.innerHTML = '<span class="cell-content">üíé</span>';
        gemsFound++;
        
        currentMultiplier = calculateMultiplier(gemsFound, minesCount);
        updateGameInfo();
        generatePayoutTable();
        
        document.getElementById('multiplierDisplay').textContent = currentMultiplier.toFixed(2) + 'x';
        
        const nextMult = calculateMultiplier(gemsFound + 1, minesCount);
        document.getElementById('nextMultiplier').textContent = nextMult.toFixed(2) + 'x';

        // Check if all gems found
        const totalGems = TOTAL_CELLS - minesCount;
        if (gemsFound >= totalGems) {
          cashout();
        }
      }
    }

    // Cashout
    function cashout() {
      if (!gameInProgress || gemsFound === 0) return;

      const winAmount = betAmount * currentMultiplier;
      const profit = winAmount - betAmount;
      
      balance += winAmount;
      totalProfit += profit;
      
      // Update stats
      stats.games++;
      stats.wins++;
      if (currentMultiplier > stats.bestMult) {
        stats.bestMult = currentMultiplier;
      }

      gameOver(true, profit);
    }

    // Game over
    function gameOver(won, profit = 0) {
      gameInProgress = false;

      if (!won) {
        profit = -betAmount;
        totalProfit += profit;
        stats.games++;
        stats.losses++;
      }

      // Reveal all cells
      revealAllCells();

      // Update UI
      updateBalance();
      updateStats();
      updateProfit();
      showResult(won, profit);
      addToHistory(won, profit);
      updateButtons();
      
      document.getElementById('gameInfo').style.display = 'none';
    }

    // Reveal all cells at game end
    function revealAllCells() {
      const cells = document.querySelectorAll('.mine-cell');
      cells.forEach((cell, index) => {
        if (revealedCells.includes(index)) return;
        
        cell.classList.add('disabled');
        
        if (minePositions.includes(index)) {
          cell.classList.add('mine-revealed');
          cell.innerHTML = '<span class="cell-content" style="opacity: 0.5;">üí£</span>';
        } else {
          cell.classList.add('gem-unrevealed');
          cell.innerHTML = '<span class="cell-content" style="opacity: 0.5;">üíé</span>';
        }
      });
    }

    // Update game info panel
    function updateGameInfo() {
      const totalGems = TOTAL_CELLS - minesCount;
      document.getElementById('gemsFound').textContent = `${gemsFound} / ${totalGems}`;
      document.getElementById('currentMult').textContent = currentMultiplier.toFixed(2) + 'x';
      document.getElementById('potentialWin').textContent = (betAmount * currentMultiplier).toFixed(2) + ' üçã';
    }

    // Update buttons
    function updateButtons() {
      const playBtn = document.getElementById('playBtn');
      const cashoutBtn = document.getElementById('cashoutBtn');
      const betInput = document.getElementById('betInput');
      const betBtns = document.querySelectorAll('.btn-small');
      const minesBtns = document.querySelectorAll('.mines-btn');

      if (gameInProgress) {
        playBtn.style.display = 'none';
        cashoutBtn.style.display = 'block';
        cashoutBtn.disabled = gemsFound === 0;
        cashoutBtn.textContent = gemsFound > 0 
          ? `üí∞ Cashout ${(betAmount * currentMultiplier).toFixed(2)} üçã`
          : 'üí∞ Cashout';
        betInput.disabled = true;
        betBtns.forEach(btn => btn.disabled = true);
        minesBtns.forEach(btn => btn.disabled = true);
      } else {
        playBtn.style.display = 'block';
        playBtn.disabled = balance < betAmount;
        cashoutBtn.style.display = 'none';
        betInput.disabled = false;
        betBtns.forEach(btn => btn.disabled = false);
        minesBtns.forEach(btn => btn.disabled = false);
        
        // Re-disable grid
        document.querySelectorAll('.mine-cell').forEach(cell => {
          if (!cell.classList.contains('revealed')) {
            cell.classList.add('disabled');
          }
        });
      }
    }

    // Update balance display
    function updateBalance() {
      document.getElementById('balanceValue').textContent = balance.toFixed(2);
    }

    // Update stats
    function updateStats() {
      document.getElementById('statGames').textContent = stats.games;
      document.getElementById('statWins').textContent = stats.wins;
      document.getElementById('statLosses').textContent = stats.losses;
      document.getElementById('statBestMult').textContent = stats.bestMult.toFixed(2) + 'x';
    }

    // Update profit display
    function updateProfit() {
      const profitEl = document.getElementById('profitValue');
      profitEl.textContent = `${totalProfit >= 0 ? '+' : ''}${totalProfit.toFixed(2)} üçã`;
      profitEl.className = totalProfit >= 0 ? 'result-value win' : 'result-value loss';
    }

    // Show result
    function showResult(won, profit) {
      const resultBox = document.getElementById('lastResult');
      const resultValue = document.getElementById('lastResultValue');
      
      resultBox.style.display = 'block';
      resultBox.className = won ? 'result-box win' : 'result-box loss';
      resultValue.className = won ? 'result-value win' : 'result-value loss';
      
      if (won) {
        resultValue.textContent = `+${profit.toFixed(2)} üçã (${currentMultiplier.toFixed(2)}x)`;
      } else {
        resultValue.textContent = `${profit.toFixed(2)} üçã`;
      }
    }

    // Add to history
    function addToHistory(won, profit) {
      history.unshift({
        id: gameIdCounter++,
        won,
        profit,
        gems: gemsFound,
        mines: minesCount,
        multiplier: won ? currentMultiplier : 0,
        bet: betAmount
      });

      if (history.length > 20) history.pop();

      const historyList = document.getElementById('historyList');
      
      if (historyList.querySelector('.history-empty')) {
        historyList.innerHTML = '';
      }

      const item = document.createElement('div');
      item.className = 'history-item';

      item.innerHTML = `
        <div class="history-item-header">
          <span class="history-result ${won ? 'win' : 'loss'}">${won ? 'WIN' : 'LOSS'}</span>
          <span class="history-profit ${won ? 'win' : 'loss'}">
            ${profit >= 0 ? '+' : ''}${profit.toFixed(2)} üçã
          </span>
        </div>
        <div class="history-details">
          ${gemsFound} üíé found | ${minesCount} üí£ | ${won ? currentMultiplier.toFixed(2) + 'x' : 'Bust'}
        </div>
      `;

      historyList.insertBefore(item, historyList.firstChild);

      while (historyList.children.length > 20) {
        historyList.removeChild(historyList.lastChild);
      }
    }

    // Select mines count
    function selectMines(count) {
      if (gameInProgress) return;
      
      minesCount = count;
      
      document.querySelectorAll('.mines-btn').forEach(btn => {
        btn.classList.toggle('active', parseInt(btn.dataset.mines) === count);
      });
      
      document.getElementById('minesBadge').textContent = `${count} Mines`;
      document.getElementById('gemsBadge').textContent = `${TOTAL_CELLS - count} Gems`;
      
      generatePayoutTable();
    }

    // Bet controls
    function adjustBet(multiplier) {
      if (gameInProgress) return;
      betAmount = Math.max(1, Math.min(balance, Math.floor(betAmount * multiplier)));
      document.getElementById('betInput').value = betAmount;
      updateButtons();
    }

    function setBetMax() {
      if (gameInProgress) return;
      betAmount = Math.floor(balance);
      document.getElementById('betInput').value = betAmount;
      updateButtons();
    }

    // Event listeners
    document.getElementById('betInput').addEventListener('change', function() {
      if (gameInProgress) return;
      betAmount = Math.max(1, Math.min(balance, parseInt(this.value) || 1));
      this.value = betAmount;
      updateButtons();
    });

    document.querySelectorAll('.mines-btn').forEach(btn => {
      btn.addEventListener('click', () => selectMines(parseInt(btn.dataset.mines)));
    });

    // Initialize
    initGrid();
    updateBalance();
    updateButtons();
    generatePayoutTable();
  </script>
</body>
</html>
